#!/bin/bash

#
# A script to train the Dawid Skene model on CrowdFlower French data using ml-engine.
#
# To run with default hyperparameters from the kaggle-classification directory just enter:
# './bin/run'
#
#
# Setup Steps:
# 1. Install the gcloud SDK
# 2. Authenticate with the GCP project you want to use, `gcloud config set project [my-project]`
# 3. Put the train data in Cloud Storage, `gsutil cp [DATA_FILE] gs://[PATH_TO_DATA]`
#
# SQL query to generate training data:
#
# SELECT * FROM (
# SELECT
#  _unit_id,
#  _worker_id,
#  identity_hate,
#  insult,
#  obscene,
#  threat,
#  toxicity_level as toxic_score,
#  SUM(CASE WHEN na is True THEN 1 ELSE 0 END) as num_na
# FROM  `[BQ_TABLE_WITH_FULL_REPORT]`
# WHERE _golden is not True
# GROUP BY 1,2,3,4,5,6,7
# ) a
# where num_na < 3
#

BUCKET_NAME=annotator_models
CONFIG=cpu_config.yaml
declare -a LABELS=("obscene" "threat" "identity_hate" "insult" "toxic_score")
MAX_ITER=50
TOLERANCE=10 # stopping condition
PSEUDO_COUNT=0.01
DATA_PATH=gs://annotator_models/dawid_skene_training_data_french.csv

REGION=us-central1
DATE=`date '+%Y%m%d_%H%M%S'`
DATE_DAY_ONLY=`date '+%Y%m%d'`
OUTPUT_PATH=gs://${BUCKET_NAME}/models/${USER}/${DATE_DAY_ONLY}_french
COMMENT_TEXT_PATH=gs://${BUCKET_NAME}/comment_text_unit_id_french.csv

echo "Writing to $OUTPUT_PATH"

## run dawid-skene for each of the labels
for label in "${LABELS[@]}"
do
    echo "Running on $label"
    JOB_NAME=${USER}_dawid_skene_french_${label}

    gcloud ml-engine jobs submit training ${JOB_NAME}_${DATE} \
	   --job-dir=${OUTPUT_PATH} \
	   --runtime-version=1.4 \
	   --config=${CONFIG} \
	   --module-name=trainer.dawid_skene \
	   --package-path=trainer \
	   --region=$REGION \
	   --verbosity=debug -- \
	   --data-path=$DATA_PATH \
	   --comment-text-path=$COMMENT_TEXT_PATH \
	   --label=$label \
	   --max-iter=$MAX_ITER \
	   --tolerance=$TOLERANCE \
	   --pseudo-count=$PSEUDO_COUNT
done
